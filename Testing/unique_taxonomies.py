import pandas as pd
import xml.etree.ElementTree as ET
import os
import itertools
import numpy as np
import csv

def directories():
    rootdir = "./global_vulnerability_model"
    location_dict = {}
    for subdir, dirs, files in os.walk(rootdir):
        for file in files:
            subdir = subdir.replace('\\', '/')
            filepath = subdir + '/' + file
            if filepath.endswith("vulnerability_structural.xml"):
                coverage_type = 'Structural'
                location = subdir.replace('./global_vulnerability_model/', '').replace('/', ' ').split()
                location_dict [location[0], location[1]] = filepath
    return location_dict

def get_taxonomies(location_list):
    tax_ids= {}
    cur_tax_id = 1
    for (continent, country) in location_list:
        pathway = location_list[(continent, country)]
        tree = ET.parse(pathway)
        root = tree.getroot()
        
        for i in range (len(root[0])-1):
            for j in root[0][i+1][0].text.strip().split(' '):
                taxonomy = root[0][i+1].attrib['id']
                if taxonomy not in tax_ids:
                    tax_ids[taxonomy] = cur_tax_id
                    cur_tax_id += 1
                    rec = {
                        # "TaxID": tax_ids[taxonomy], 
                        "Taxonomy": taxonomy
                    }
                    yield rec

def main():    
    directory = directories()
    location_list = directory
    header = get_taxonomies(location_list)
    df = pd.DataFrame(header)
    # print (df.head(5))
    df.to_csv('GEM/taxonomies.csv', index=False)

main()