import rasterio
import numpy as np
import pandas as pd
import csv

raster_filepath = 'GlobalFloodingVariants/PH_TW_20240724_Typhoon_Gaemi_FLRF_D_RD_30m_4326.tif'

with rasterio.open(raster_filepath) as image:
        
    max_lat = image.bounds[3]
    min_lat = image.bounds[1]
    max_long = image.bounds[2]
    min_long = image.bounds[0]
    no_height_pixels = image.height
    no_width_pixels = image.width
    raster = image.read(1)

def create_areaperil_dict():
    
    width_per_pixel = (max_long - min_long) / no_width_pixels
    height_per_pixel = (max_lat - min_lat) / no_height_pixels

    lat_incr = 0
    areaperil_id = 0
    
    for row in raster:
        
        long_incr = 0
        latitude = height_per_pixel * (0.5 + lat_incr) + min_lat

        for cell in row:
            
            longitude = width_per_pixel * (0.5 + long_incr) + max_long
            areaperil_id += 1
            areaperil_dict = { "area_peril_id": areaperil_id, "longitude": longitude, "latitude": latitude}
            yield areaperil_dict
            long_incr += 1
        lat_incr += 1

def create_footprint():

    areaperil_id = 0

    for row in raster:
        for intensity in row:

            if intensity < 0:
                intensity = 'NaN'
                
            areaperil_id += 1
            footprint_row = { "event_id": 1, "area_peril_id": areaperil_id, "intensity": intensity, "probability": 1}
            yield footprint_row

with open('GlobalFloodingVariants/footprint.csv', mode='w', newline='') as file:

    writer = csv.DictWriter(file, fieldnames=["event_id","area_peril_id","intensity","probability"])

    writer.writeheader()

    for row in create_footprint():
        writer.writerow(row)

print("CSV file has been created.")
