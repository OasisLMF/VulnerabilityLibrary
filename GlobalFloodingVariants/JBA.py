import rasterio
import numpy as np
import pandas as pd
import csv

def create_areaperil_dict(filepath):
    
    with rasterio.open(filepath) as image:
        
        max_lat = image.bounds[3]
        min_lat = image.bounds[1]
        max_long = image.bounds[2]
        min_long = image.bounds[0]

        no_height_pixels = image.height
        no_width_pixels = image.width

        raster = image.read(1)


    width_per_pixel = (max_long - min_long) / no_width_pixels
    height_per_pixel = (max_lat - min_lat) / no_height_pixels

    n = 0
    areaperil_id = 0
    
    for row in raster:
        
        m = 0
        latitude = height_per_pixel * (0.5 + n) + min_lat

        for cell in row:
            
            longitude = width_per_pixel * (0.5 + m) + max_long
            areaperil_id += 1
            areaperil_dict = { "area_peril_id": areaperil_id, "longitude": longitude, "latitude": latitude}
            yield areaperil_dict
            m += 1
        n += 1

def create_footprint(filepath):
    
    with rasterio.open(filepath) as image:
        raster = image.read(1)

    areaperil_id = 0
    for row in raster:
        for intensity in row:
            if intensity < 0:
                intensity = 'NaN'
            areaperil_id += 1
            footprint_row = { "event_id": 1, "area_peril_id": areaperil_id, "intensity": intensity, "probability": 1}
            yield footprint_row
            
filepath = 'GlobalFloodingVariants/PH_TW_20240724_Typhoon_Gaemi_FLRF_D_RD_30m_4326.tif'

with open('GlobalFloodingVariants/footprint.csv', mode='w', newline='') as file:

    writer = csv.DictWriter(file, fieldnames=["event_id","area_peril_id","intensity","probability"])

    writer.writeheader()

    for row in create_footprint(filepath):
        writer.writerow(row)

print("CSV file has been created.")
