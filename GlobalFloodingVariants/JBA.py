import rasterio
import numpy as np
import pandas as pd
import csv

def create_areaperil_dict(filepath):
    
    with rasterio.open(filepath) as image:
        
        max_lat = image.bounds[3]
        min_lat = image.bounds[1]
        max_long = image.bounds[2]
        min_long = image.bounds[0]

        no_height_pixels = image.height
        no_width_pixels = image.width

        raster = image.read(1)


    width_per_pixel = (max_long - min_long) / no_width_pixels
    height_per_pixel = (max_lat - min_lat) / no_height_pixels

    n = 0
    areaperil_id = 0
    
    for row in raster:
        
        m = 0
        latitude = height_per_pixel * (0.5 + n) + min_lat

        for cell in row:
            
            longitude = width_per_pixel * (0.5 + m) + max_long
            areaperil_id += 1
            areaperil_dict = { "area_peril_id": areaperil_id, "longitude": longitude, "latitude": latitude}
            yield areaperil_dict
            m += 1
        n += 1

filepath = 'JBA/PH_TW_20240724_Typhoon_Gaemi_FLRF_D_RD_30m_4326.tif'

with rasterio.open(filepath) as image:
    boundingbox = image.bounds
    raster = image.read(1)
print(boundingbox)

with open('JBA/areaperil_dict.csv', mode='w', newline='') as file:

    writer = csv.DictWriter(file, fieldnames=["area_peril_id","longitude","latitude"])

    writer.writeheader()

    for row in create_areaperil_dict(filepath):
        writer.writerow(row)

print("CSV file has been created.")

